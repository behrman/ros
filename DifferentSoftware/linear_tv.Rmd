---
title: "Regression and Other Stories: Different software options"
author: "Andrew Gelman, Aki Vehtari"
date: "`r Sys.Date()`"
output:
  github_document:
    toc: true
---
Tidyverse version by Bill Behrman.

Linear regression using different software options. See Appendix A in
Regression and Other Stories.

-------------

```{r, message=FALSE}
# Packages
library(tidyverse)
library(arm)
library(brms)
library(rstanarm)
library(tidymodels)

# Parameters
  # Common code
file_common <- here::here("_common.R")

#===============================================================================

# Run common code
source(file_common)
```

# A Computing in R

## A.8 Working with rstanarm fit objects

Simulated data.

```{r}
set.seed(563)

n <- 100

b <- 1:3
sigma <- 2

data <- 
  tibble(
    x_1 = rnorm(n),
    x_2 = rnorm(n),
    y = b[1] + b[2] * x_1 + b[3] * x_2 + rnorm(n, mean = 0, sd = sigma)
  )
```

#### Fit and display using `lm()`

```{r}
fit_lm <- lm(y ~ x_1 + x_2, data = data)

display(fit_lm)
```

Extract coefficient estimates.

```{r}
coef(fit_lm)
```

Extract coefficient uncertainties.

```{r}
se.coef(fit_lm)
```

#### Fit and display using `stan_glm()`

```{r}
set.seed(925)

fit_stan_glm <- stan_glm(y ~ x_1 + x_2, data = data, refresh = 0)

print(fit_stan_glm, digits = 2)
```

Run again with different seed to see some simulation variability.

```{r}
set.seed(552)

fit_stan_glm <- stan_glm(y ~ x_1 + x_2, data = data, refresh = 0)

print(fit_stan_glm, digits = 2)
```

Extract coefficient estimates.

```{r}
coef(fit_stan_glm)
```

Extract coefficient uncertainties.

```{r}
se(fit_stan_glm)
```

#### Fit and display using tidymodels

Tidymodels is an ecosystem of R packages for modeling. It has an advantage of providing a common interface to a growing number of [model types and engines](https://www.tidymodels.org/find/parsnip/). It can be used for modeling tasks such as data preprocessing, resampling, and parameter tuning. You can learn more at:

* [Tidymodels](https://www.tidymodels.org/)
* [Tidy Modeling with R](https://www.tmwr.org/)

We will illustrate how to fit the above two models.

Each type of model supported by tidymodels may have multiple computational engines. Here are the ones currently available for linear regression.

```{r}
show_engines("linear_reg")
```

Here's how to fit the linear regression using `lm()`.

```{r}
fit_tm_lm <- 
  linear_reg() %>% 
  set_engine("lm") %>% 
  fit(y ~ x_1 + x_2, data = data)

fit_tm_lm
```

The tidymodels fit contains the `lm()` fit.

```{r}
display(fit_tm_lm$fit)
```

Here's how to fit the linear regression using Stan.

```{r}
set.seed(552)

fit_tm_stan <- 
  linear_reg() %>% 
  set_engine("stan") %>% 
  fit(y ~ x_1 + x_2, data = data)

fit_tm_stan
```

The tidymodels fit contains the Stan fit.

```{r}
print(fit_tm_stan$fit, digits = 2)
```

### Fitting Stan models in R using brms

#### Fit and display using brms

This will take longer as the model is not pre-compiled as in `stan_glm()`.

```{r, message=FALSE, warning=FALSE, error=FALSE, results=FALSE}
set.seed(552)

fit_brm <- brm(y ~ x_1 + x_2, data = data, refresh = 0)
```

```{r}
print(fit_brm, digits = 2)
```

Stan code generated by brms can be used to learn Stan or get a starting point for a model which is not yet implemented in rstanarm or brms.

```{r}
stancode(fit_brm)
```

